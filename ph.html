<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å…­é‚Šå½¢çµæ§‹æ­¸é¡å™¨ (Excel/ZIP åŒ¯å‡ºç‰ˆ)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --secondary: #10b981;
            --secondary-hover: #059669;
            --accent: #f59e0b; /* Amber for ZIP */
            --bg-gradient: linear-gradient(135deg, #e0e7ff 0%, #f3e8ff 100%);
            --surface: rgba(255, 255, 255, 0.95);
            --border: #e2e8f0;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background: var(--surface);
            backdrop-filter: blur(10px);
            padding: 3rem;
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255,255,255,0.5);
        }

        header { text-align: center; margin-bottom: 3rem; }
        h1 {
            margin: 0;
            font-size: 2.2rem;
            font-weight: 800;
            background: -webkit-linear-gradient(45deg, #4f46e5, #9333ea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .desc { margin-top: 0.5rem; color: var(--text-sub); }

        /* Upload Area */
        .upload-area {
            border: 3px dashed #cbd5e1;
            border-radius: 16px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: rgba(248, 250, 252, 0.5);
        }
        .upload-area:hover {
            border-color: var(--primary);
            background-color: #eef2ff;
            transform: translateY(-2px);
        }
        .upload-icon { font-size: 3.5rem; margin-bottom: 1rem; }

        /* Controls */
        .controls-wrapper {
            display: flex;
            gap: 20px;
            margin-top: 2rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        .setting-card {
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        input[type="number"] {
            padding: 8px;
            border-radius: 8px;
            border: 2px solid var(--border);
            width: 70px;
            font-weight: 600;
            color: var(--primary);
            text-align: center;
        }

        /* Buttons */
        .btn-group {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 2rem;
            flex-wrap: wrap;
        }
        button {
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: white;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        button:disabled { background-color: #cbd5e1; cursor: not-allowed; box-shadow: none; }
        
        .btn-primary { background-color: var(--primary); }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-hover); transform: translateY(-2px); }
        
        .btn-excel { background-color: var(--secondary); display: none; }
        .btn-excel:hover { background-color: var(--secondary-hover); transform: translateY(-2px); }
        
        .btn-zip { background-color: var(--accent); display: none; }
        .btn-zip:hover { background-color: #d97706; transform: translateY(-2px); }

        /* Progress & Log */
        .progress-container {
            width: 100%;
            height: 10px;
            background: #e2e8f0;
            border-radius: 5px;
            margin-top: 2rem;
            overflow: hidden;
            display: none;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, #a855f7 100%);
            width: 0%;
            transition: width 0.3s;
        }
        #statusLog { text-align: center; margin-top: 1rem; color: var(--text-sub); height: 24px; }

        /* Results Grid */
        .results { margin-top: 3rem; display: flex; flex-direction: column; gap: 2rem; }
        .group-block {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            animation: fadeIn 0.5s ease-out;
        }
        .group-header {
            background: #f8fafc;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .group-title { font-weight: 700; color: var(--text-main); }
        .badge {
            background: #e0e7ff; color: var(--primary);
            padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;
        }
        .group-content {
            padding: 1.5rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 16px;
            max-height: 400px;
            overflow-y: auto;
        }
        .img-card {
            cursor: pointer;
            transition: transform 0.2s;
            text-align: center;
        }
        .img-card:hover { transform: translateY(-4px); }
        .img-wrapper {
            width: 100%; aspect-ratio: 1;
            background: white; border: 2px solid var(--border); border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 8px;
        }
        .img-wrapper img { max-width: 90%; max-height: 90%; object-fit: contain; }
        .img-name { font-size: 0.75rem; color: var(--text-sub); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Modal */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(15, 23, 42, 0.9); backdrop-filter: blur(5px);
            justify-content: center; align-items: center;
        }
        .modal-content { max-width: 90%; max-height: 90vh; border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        .modal-close { position: absolute; top: 20px; right: 30px; color: white; font-size: 2.5rem; cursor: pointer; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ§© AI å…­é‚Šå½¢çµæ§‹æ­¸é¡å™¨</h1>
        <p class="desc">è‡ªå‹•å¿½ç•¥é¡è‰²èˆ‡è§’åº¦å·®ç•° â€¢ ä¸€éµåŒ¯å‡º Excel èˆ‡æ•´ç†å¥½çš„ ZIP</p>
    </header>

    <div class="upload-area" id="dropZone">
        <div class="upload-icon">ğŸ“‚</div>
        <h3>é»æ“Šæˆ–æ‹–æ›³åœ–ç‰‡è‡³æ­¤</h3>
        <p>æ”¯æ´ PNG, JPG (å»ºè­°å…¨é¸è³‡æ–™å¤¾å…§çš„åœ–ç‰‡)</p>
        <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
    </div>

    <div class="controls-wrapper">
        <div class="setting-card">
            <span>å®¹è¨±å·®ç•° (Distance):</span>
            <input type="number" id="thresholdInput" value="5" min="0" max="20" title="è¶Šå°è¶Šåš´æ ¼">
        </div>
        <div class="setting-card">
            <span>ç‰¹å¾µç²¾åº¦ (Hash Size):</span>
            <input type="number" id="hashSizeInput" value="16" min="8" max="32" title="å»ºè­° 16">
        </div>
    </div>

    <div class="btn-group">
        <button id="processBtn" class="btn-primary" disabled>ğŸš€ é–‹å§‹åˆ†æ</button>
        <button id="excelBtn" class="btn-excel">ğŸ“Š ä¸‹è¼‰ Excel å ±è¡¨</button>
        <button id="zipBtn" class="btn-zip">ğŸ“¦ ä¸‹è¼‰åˆ†é¡å¥½çš„ ZIP</button>
    </div>

    <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    <div id="statusLog">æº–å‚™å°±ç·’</div>

    <div id="resultsArea" class="results"></div>
</div>

<div id="imgModal" class="modal" onclick="closeModal()">
    <span class="modal-close">&times;</span>
    <img class="modal-content" id="modalImg">
</div>

<script>
    // --- DOM Elements ---
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const processBtn = document.getElementById('processBtn');
    const excelBtn = document.getElementById('excelBtn');
    const zipBtn = document.getElementById('zipBtn');
    const statusLog = document.getElementById('statusLog');
    const progressBar = document.getElementById('progressBar');
    const resultsArea = document.getElementById('resultsArea');
    const modal = document.getElementById('imgModal');
    const modalImg = document.getElementById('modalImg');

    // --- State ---
    let selectedFiles = [];
    let processingGroups = []; // Stores the final result
    const ANGLES = [0, 60, 120, 180, 240, 300];
    const BINARY_THRESHOLD = 200;

    // --- Event Listeners ---
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => { e.preventDefault(); handleFiles(e.dataTransfer.files); });
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
    
    processBtn.addEventListener('click', startAnalysis);
    excelBtn.addEventListener('click', downloadExcel);
    zipBtn.addEventListener('click', downloadZip);

    // --- Core Functions ---

    function handleFiles(files) {
        const imgs = Array.from(files).filter(f => f.type.startsWith('image/'));
        if (imgs.length === 0) return;
        selectedFiles = [...selectedFiles, ...imgs];
        statusLog.textContent = `âœ… å·²è¼‰å…¥ ${selectedFiles.length} å¼µåœ–ç‰‡`;
        processBtn.disabled = false;
        processBtn.innerHTML = `ğŸš€ é–‹å§‹åˆ†æ ${selectedFiles.length} å¼µåœ–ç‰‡`;
        excelBtn.style.display = 'none';
        zipBtn.style.display = 'none';
        resultsArea.innerHTML = '';
    }

    function loadImage(file) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.src = URL.createObjectURL(file);
        });
    }

    function preprocessImage(img, size) {
        const canvas = document.createElement('canvas');
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, size, size);
        const w = img.naturalWidth, h = img.naturalHeight;
        ctx.drawImage(img, (size - w) / 2, (size - h) / 2);
        
        const data = ctx.getImageData(0, 0, size, size).data;
        for (let i = 0; i < data.length; i += 4) {
            const gray = data[i]*0.299 + data[i+1]*0.587 + data[i+2]*0.114;
            const val = gray > BINARY_THRESHOLD ? 255 : 0;
            data[i] = val; data[i+1] = val; data[i+2] = val;
        }
        ctx.putImageData(new ImageData(data, size, size), 0, 0);
        return canvas;
    }

    function getRotatedCanvas(source, angle) {
        if (angle === 0) return source;
        const size = source.width;
        const canvas = document.createElement('canvas');
        canvas.width = size; canvas.height = size;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#FFFFFF'; ctx.fillRect(0, 0, size, size);
        ctx.translate(size/2, size/2);
        ctx.rotate(angle * Math.PI / 180);
        ctx.drawImage(source, -size/2, -size/2);
        return canvas;
    }

    function calculateHash(canvas, hashSize) {
        const small = document.createElement('canvas');
        small.width = hashSize; small.height = hashSize;
        const ctx = small.getContext('2d');
        ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(canvas, 0, 0, hashSize, hashSize);
        const data = ctx.getImageData(0, 0, hashSize, hashSize).data;
        let pixels = [], sum = 0;
        for(let i=0; i<data.length; i+=4) { pixels.push(data[i]); sum += data[i]; }
        const avg = sum / pixels.length;
        return pixels.map(p => p > avg ? '1' : '0').join('');
    }

    function hammingDistance(s1, s2) {
        let dist = 0;
        for(let i=0; i<s1.length; i++) if(s1[i] !== s2[i]) dist++;
        return dist;
    }

    async function startAnalysis() {
        if (!selectedFiles.length) return;
        processBtn.disabled = true;
        document.getElementById('progressContainer').style.display = 'block';
        
        const hashSize = parseInt(document.getElementById('hashSizeInput').value) || 16;
        const threshold = parseInt(document.getElementById('thresholdInput').value) || 5;
        let fileData = [];

        // Step 1: Feature Extraction
        for (let i = 0; i < selectedFiles.length; i++) {
            statusLog.textContent = `æ­£åœ¨æå–ç‰¹å¾µ (${i+1}/${selectedFiles.length})...`;
            progressBar.style.width = `${((i+1)/selectedFiles.length)*50}%`;
            
            try {
                const img = await loadImage(selectedFiles[i]);
                const size = Math.max(img.naturalWidth, img.naturalHeight);
                const base = preprocessImage(img, size);
                
                let minHash = null;
                for (const angle of ANGLES) {
                    const rot = getRotatedCanvas(base, angle);
                    const h = calculateHash(rot, hashSize);
                    if (minHash === null || h < minHash) minHash = h;
                }
                fileData.push({ file: selectedFiles[i], hash: minHash, name: selectedFiles[i].name });
            } catch (e) { console.error(e); }
            await new Promise(r => setTimeout(r, 0));
        }

        // Step 2: Clustering
        statusLog.textContent = "æ­£åœ¨é€²è¡Œæ™ºæ…§æ­¸é¡...";
        let groups = [];
        for (let i = 0; i < fileData.length; i++) {
            const item = fileData[i];
            let match = null;
            for (let g of groups) {
                if (hammingDistance(item.hash, g.repHash) <= threshold) { match = g; break; }
            }
            if (match) match.files.push(item);
            else groups.push({ repHash: item.hash, files: [item] });
            progressBar.style.width = `${50 + ((i+1)/fileData.length)*50}%`;
        }

        groups.sort((a, b) => b.files.length - a.files.length);
        processingGroups = groups;
        renderResults(groups);

        statusLog.textContent = `ğŸ‰ å®Œæˆï¼å…±åˆ†ç‚º ${groups.length} å€‹ç¾¤çµ„`;
        processBtn.textContent = 'é‡æ–°åˆ†æ';
        processBtn.disabled = false;
        excelBtn.style.display = 'flex';
        zipBtn.style.display = 'flex';
        progressBar.style.width = '100%';
    }

    function renderResults(groups) {
        resultsArea.innerHTML = '';
        groups.forEach((group, idx) => {
            const div = document.createElement('div');
            div.className = 'group-block';
            div.innerHTML = `
                <div class="group-header">
                    <span class="group-title">ç¾¤çµ„ ${idx+1}</span>
                    <span class="badge">${group.files.length} å¼µ</span>
                </div>
                <div class="group-content"></div>
            `;
            const content = div.querySelector('.group-content');
            group.files.forEach(item => {
                const card = document.createElement('div');
                card.className = 'img-card';
                card.onclick = () => openModal(item.file);
                card.innerHTML = `
                    <div class="img-wrapper"><img src="${URL.createObjectURL(item.file)}"></div>
                    <div class="img-name">${item.name}</div>
                `;
                content.appendChild(card);
            });
            resultsArea.appendChild(div);
        });
    }

    // --- Export Functions ---

    function downloadExcel() {
        if (!processingGroups.length) return;
        
        // æº–å‚™ Excel æ•¸æ“š
        let data = [];
        processingGroups.forEach((group, idx) => {
            const groupName = `Group_${String(idx+1).padStart(2, '0')}`;
            group.files.forEach(item => {
                data.push({
                    "ç¾¤çµ„åç¨±": groupName,
                    "æª”æ¡ˆåç¨±": item.name,
                    "åœ–ç‰‡æ•¸é‡": group.files.length
                });
            });
        });

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "åˆ†é¡çµæœ");
        XLSX.writeFile(wb, "åˆ†é¡æ¸…å–®.xlsx");
    }

    function downloadZip() {
        if (!processingGroups.length) return;
        statusLog.textContent = "ğŸ“¦ æ­£åœ¨æ‰“åŒ… ZIPï¼Œè«‹ç¨å€™...";
        
        const zip = new JSZip();
        
        processingGroups.forEach((group, idx) => {
            const folderName = `Group_${String(idx+1).padStart(2, '0')}`;
            const folder = zip.folder(folderName);
            
            group.files.forEach(item => {
                folder.file(item.name, item.file);
            });
        });

        zip.generateAsync({type:"blob"}).then(function(content) {
            saveAs(content, "æ•´ç†å¥½çš„åœ–ç‰‡.zip");
            statusLog.textContent = "âœ… ZIP ä¸‹è¼‰å·²é–‹å§‹ï¼";
        });
    }

    // --- Modal Functions ---
    function openModal(file) {
        modal.style.display = "flex";
        modalImg.src = URL.createObjectURL(file);
    }
    function closeModal() { modal.style.display = "none"; }
    window.onclick = (e) => { if(e.target == modal) closeModal(); }

</script>
</body>
</html>
